From c2924cc57c9e4aa836021ec2567c0fdbebecf944 Mon Sep 17 00:00:00 2001
From: Adrian Vladu <avladu@cloudbasesolutions.com>
Date: Fri, 16 Feb 2024 11:29:04 +0000
Subject: [PATCH 6/9] units: Keep using old journal file format

Systemd 252 made an incompatible change in journal file format. Temporarily
force journald to use the old journal format to give logging containers more
time to adapt to the new format.

Signed-off-by: Adrian Vladu <avladu@cloudbasesolutions.com>
---
 units/systemd-journald.service.in  | 1 +
 units/systemd-journald@.service.in | 1 +
 2 files changed, 2 insertions(+)

diff --git a/units/systemd-journald.service.in b/units/systemd-journald.service.in
index 4404af963b..323af7cfb0 100644
--- a/units/systemd-journald.service.in
+++ b/units/systemd-journald.service.in
@@ -30,6 +30,7 @@ IgnoreOnIsolate=yes
 
 [Service]
 DeviceAllow=char-* rw
+Environment=SYSTEMD_JOURNAL_COMPACT=0
 ExecStart={{LIBEXECDIR}}/systemd-journald
 FileDescriptorStoreMax=4224
 # Ensure services using StandardOutput=journal do not break when journald is stopped
diff --git a/units/systemd-journald@.service.in b/units/systemd-journald@.service.in
index b705ce08ff..874701dac4 100644
--- a/units/systemd-journald@.service.in
+++ b/units/systemd-journald@.service.in
@@ -16,6 +16,7 @@ After=systemd-journald@%i.socket systemd-journald-varlink@%i.socket
 [Service]
 CapabilityBoundingSet=CAP_SYS_ADMIN CAP_DAC_OVERRIDE CAP_SYS_PTRACE CAP_CHOWN CAP_DAC_READ_SEARCH CAP_FOWNER CAP_SETUID CAP_SETGID CAP_MAC_OVERRIDE
 DevicePolicy=closed
+Environment=SYSTEMD_JOURNAL_COMPACT=0
 ExecStart={{LIBEXECDIR}}/systemd-journald %i
 FileDescriptorStoreMax=4224
 Group=systemd-journal
-- 
2.51.0

