cros_post_src_install_timesync() {
  local dir="${D}$(systemd_get_systemunitdir)/systemd-timesyncd.service.d"
  mkdir -p "${dir}"
  pushd "${dir}"
  cat <<EOF >flatcar.conf || die
# Allow sysexts to ship timesyncd replacements which can have
# a Conflicts=systemd-timesyncd directive that would result
# in systemd-timesyncd not being started.
[Unit]
After=ensure-sysext.service
EOF
  popd
}

cros_post_src_install_udev() {
  insinto "$(systemd_get_systemunitdir)/systemd-udevd.service.d"
  newins - flatcar.conf <<EOF
# In Flatcar we are using modprobe helpers that run depmod in temporary
# overlay. systemd-udevd.service may try to load drivers for some block devices
# (e.g. ZFS), which ends up calling our helpers, which invoke mount command.
# The mount syscalls are forbidden by the default systemd-udevd syscall filter.

[Service]
SystemCallFilter=@mount
EOF
}
