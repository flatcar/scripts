systemd_meson_args_array=(
    # Flatcar: Point to our user mailing list.
    -Dsupport-url='https://groups.google.com/forum/#!forum/flatcar-linux-user'

    # Flatcar: Use our ntp servers.
    -Dntp-servers="0.flatcar.pool.ntp.org 1.flatcar.pool.ntp.org 2.flatcar.pool.ntp.org 3.flatcar.pool.ntp.org"

    # Flatcar: Specify this, or meson breaks due to no
    # /etc/login.defs.
    -Dsystem-gid-max=999
    -Dsystem-uid-max=999

    # Flatcar: DBus paths.
    -Ddbussessionservicedir="${EPREFIX}/usr/share/dbus-1/services"
    -Ddbussystemservicedir="${EPREFIX}/usr/share/dbus-1/system-services"

    # Flatcar: PAM config directory.
    -Dpamconfdir=/usr/share/pam.d

    # Flatcar: The CoreOS epoch, Mon Jul 1 00:00:00 UTC 2013. Used by
    # timesyncd as a sanity check for the minimum acceptable
    # time. Explicitly set to avoid using the current build time.
    -Dtime-epoch=1372636800

    # Flatcar: No default name servers.
    -Ddns-servers=

    # Flatcar: Disable the "First Boot Wizard", it isn't very
    # applicable to us.
    -Dfirstboot=false

    # Flatcar: Set latest network interface naming scheme for
    # https://github.com/flatcar/Flatcar/issues/36
    -Ddefault-net-naming-scheme=latest

    # Flatcar: Combined log format: name plus description
    -Dstatus-unit-format-default=combined

    # Flatcar: Disable multicast-dns, Link-Local Multicast Name
    # Resolution and dnssec
    -Ddefault-mdns=no
    -Ddefault-llmnr=no
    -Ddefault-dnssec=no
)
export MYMESONARGS="${systemd_meson_args_array[*]@Q}"
unset 'systemd_meson_args_array'

# A hack to avoid enabling getty remote-fs targets in pkg_postinst, we
# already do out ourselves in this file.
if ! declare -pf flatcar_hacked_systemctl >/dev/null 2>&1; then
    flatcar_hacked_systemctl=$(command -v systemctl)
fi
systemctl() {
    if [[ ${#} -eq 4 && ${1} = '--root='* && ${2} = 'enable' && ${3} = 'getty@.service' && ${4} = 'remote-fs.target' ]]; then
        return 0
    fi
    "${flatcar_hacked_systemctl}" "${@}"
}

cros_post_src_install_flatcar_stuff() {
    # We provide our own systemd-user config file in baselayout.
    rm "${ED}/usr/share/pam.d/systemd-user" || die

    # Ensure journal directory has correct ownership/mode in inital
    # image. This is fixed by systemd-tmpfiles *but* journald starts
    # before that and will create the journal if the filesystem is
    # already read-write. Conveniently the systemd Makefile sets this
    # up completely wrong.
    #
    # TODO: Is this still a problem?
    keepdir /var/log/journal
    fowners root:systemd-journal /var/log/journal
    fperms 2755 /var/log/journal

    keepdir /var/log/journal/remote
    fowners systemd-journal-remote:systemd-journal-remote /var/log/journal/remote

    (
        insopts -m 0644
        insinto /usr/lib/tmpfiles.d
        # Don't prune systemd dirs. TODO: Unnecessary with keepdir above.
        newins - systemd-flatcar.conf <<'EOF'
d   /var/log/journal/remote -   systemd-journal-remote   systemd-journal-remote   -   -
EOF

        # Add tmpfiles rule for resolv.conf. This path has changed
        # after v213 so it must be handled here instead of baselayout
        # now.
        newins - systemd-resolv.conf <<'EOF'
d   /run/systemd/network                -   -   -   -   -
L   /run/systemd/network/resolv.conf    -   -   -   -   ../resolve/resolv.conf
EOF
    )

    # Don't set any extra environment variables by default.
    rm "${ED}/usr/lib/environment.d/99-environment.conf" || die

    # enable system units
    systemctl --root="${ED}" --system --preset-mode=enable-only preset-all || die
    mv "${ED}/etc/systemd/system/"* "$(systemd_get_systemunitdir)" || die
    # enable user units
    systemctl --root="${ED}" --global --preset-mode=enable-only preset-all || die
    mv "${ED}/etc/systemd/user/"* "$(systemd_get_userunitdir)" || die

    # Use an empty preset file, because systemctl preset-all puts
    # symlinks in /etc, not in /usr. We don't use /etc, because it is
    # not autoupdated. We do the "preset" above.
    rm "${ED}/usr/lib/systemd/system-preset/90-systemd.preset" || die
    rm "${ED}/usr/lib/systemd/user-preset/90-systemd.preset" || die
    insinto /usr/lib/systemd/system-preset
    newins - 99-default.preset <<'EOF'
# Do not enable any services if /etc is detected as empty.
disable *
EOF

    # Do not ship distro-specific files (nsswitch.conf pam.d). This
    # conflicts with our own configuration provided by baselayout.
    rm -r "${ED}"/usr/share/factory || die
    sed -i "${ED}"/usr/lib/tmpfiles.d/etc.conf \
        -e '/^C!* \/etc\/nsswitch\.conf/d' \
        -e '/^C!* \/etc\/pam\.d/d' \
        -e '/^C!* \/etc\/issue/d' || die

    # Some OEMs prefer chronyd, so allow them to replace
    # systemd-timesyncd with it.
    insinto "$(systemd_get_systemunitdir)/systemd-timesyncd.service.d"
    newins - flatcar.conf <<'EOF'
# Allow sysexts to ship timesyncd replacements which can have
# a Conflicts=systemd-timesyncd directive that would result
# in systemd-timesyncd not being started.
[Unit]
After=ensure-sysext.service
EOF
}
